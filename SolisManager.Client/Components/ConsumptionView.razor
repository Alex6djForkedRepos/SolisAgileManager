@inject IInverterManagerService inverterManagerService
@implements IDisposable

<PageTitle>Solis Manager</PageTitle>

<ErrorBoundary>
    <TopStatusBar PageTitle="Costs" @bind-SelectedView="selectedView" ViewSettingName="cost-view">
        <ChildContent>
            <div class="consumption-header">
                <MudSelect T="int" @bind-Value="dayRange" @bind-Value:after="RecalcConsmption" Label="Range" 
                           Dense="true" Variant="UIConstants.MudVariant" Margin="Margin.Dense">
                    @foreach (var range in DateRanges)
                    {
                        <MudSelectItem T="int" Value="@range.days">@range.name</MudSelectItem>
                    }
                </MudSelect>
                <MudSelect T="GroupByType" @bind-Value="selectedGrouping" @bind-Value:after="RecalcConsmption" 
                           Label="Group By" Dense="true" Variant="UIConstants.MudVariant" Margin="Margin.Dense">
                    @foreach (var group in Enum.GetValues<GroupByType>())
                    {
                        <MudSelectItem T="GroupByType" Value="@group">@group.Humanize()</MudSelectItem>
                    }
                </MudSelect>
                <div class="total-cost">Total: <Price Value="@TotalNetCost" Colours="Price.ColorType.PositiveRed" /></div>
            </div>
        </ChildContent>
    </TopStatusBar>

    @if(accountValid != null &&!accountValid.Value)
    {
        <div>Please configure your Octopus API Key and Account number in the settings screen to see consumption data.</div>
    }
    else if( loading || consumptionData == null)
    {
        <ProgressIndicator ProgressText="@ProgressMessage"/>
    }
    else
    {
        @if (selectedView == ViewSelector.ViewType.Chart)
        {
            <ConsumptionChart ChartData="consumptionData"/>
        }
        else
        {
            <MudTable Items="consumptionData" Dense="true" Breakpoint="Breakpoint.None">
                <HeaderContent>
                    <MudTh>Period</MudTh>
                    <MudTh>Tariff</MudTh>
                    <MudTh>Standing Charge</MudTh>
                    <MudTh>Imported (kWh)</MudTh>
                    <MudTh>Import Price Paid (p/kWh)</MudTh>
                    <MudTh>Import Cost (£)</MudTh>
                    <MudTh>Exported (kWh)</MudTh>
                    <MudTh>Export Price Earned (p/kWh)</MudTh>
                    <MudTh>Export Profit (£)</MudTh>
                    <MudTh>Net Cost (£)</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd><DateDisplay Date="@context.StartTime"/></MudTd>
                    <MudTd>@context.Tariffs</MudTd>
                    <MudTd>@Math.Round(context.AverageStandingCharge, 2)</MudTd>
                    <MudTd>@Math.Round(context.TotalImport, 2)</MudTd>
                    <MudTd>@Math.Round(context.AverageImportPrice, 2)</MudTd>
                    <MudTd><Price Value="@(context.TotalImportCost)"/></MudTd>
                    <MudTd>@Math.Round(context.TotalExport, 2)</MudTd>
                    <MudTd>@Math.Round(context.AverageExportPrice, 2)</MudTd>
                    <MudTd><Price Value="@(context.TotalExportProfit)"/></MudTd>
                    <MudTd><Price Value="@(context.NetCost)" Colours="Price.ColorType.PositiveRed"/></MudTd>
                </RowTemplate>
            </MudTable>
        }

        <div><strong>Note:</strong> Consumption costs are currently shown without the standing charge.</div>
    }
</ErrorBoundary>

@code {
    private bool? accountValid = null;
    private bool loading = true;
    private SolisManagerConfig? config;
    private IEnumerable<GroupedConsumption>? consumptionData = null;
    private ViewSelector.ViewType selectedView = ViewSelector.ViewType.Grid;
    private CancellationTokenSource tokenSource = new();
    private int dayRange = 30;
    private string ProgressMessage => $"Loading {dayRange} days of consumption and tariff data..." + 
                                      (dayRange <= 30 ? string.Empty : " Please be patient, this may take some time.");
    private GroupByType selectedGrouping = GroupByType.Day;
    

    private (string name, int days)[] DateRanges =
    [
        ("1 week", 7),
        ("2 weeks", 14),
        ("30 days", 30),
        ("60 days", 60),
        ("3 months", 90),
        ("6 months", 180),
        ("1 year", 365),
        ("This year", (int)(DateTime.UtcNow - new DateTime(DateTime.UtcNow.Year, 1, 1)).TotalDays),
    ];

    private string TariffSummary(OctopusConsumption? item) => $"{item?.Tariff}" + (item?.DailyStandingCharge != null ? $" ({item.DailyStandingCharge:F2}p/day)" : string.Empty);
    private decimal TotalNetCost => consumptionData?.Sum(x => x.NetCost) ?? 0M;
    
    public void Dispose()
    {
        tokenSource.Cancel();
    }

    private async Task RecalcConsmption()
    {
        loading = true;
        StateHasChanged();

        tokenSource.Cancel();
        tokenSource = new();
        
        // Consumption data is rarely available before 2pm so if it's before 
        // that skip 2 days. Otherwise go back one day. 
        // Even then, export data may not be available...
        int offset = DateTime.UtcNow.Hour < 14 ? -2 : -1;
        
        var end = DateTime.UtcNow.AddDays(offset);
        var start = end.AddDays(-1 * dayRange);
        consumptionData = await inverterManagerService.GetConsumption(start, end, selectedGrouping, tokenSource.Token);
        
        loading = false;
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        config = await inverterManagerService.GetConfig();
        accountValid = !string.IsNullOrEmpty(config.OctopusAPIKey) && !string.IsNullOrEmpty(config.OctopusAccountNumber);
        
        await RecalcConsmption();

        await base.OnInitializedAsync();
    }
}